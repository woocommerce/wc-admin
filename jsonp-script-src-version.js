const pluginName = 'JsonpScriptSrcVersionParameterPlugin';
/**
 * From: https://github.com/webpack/webpack/issues/8115#issuecomment-663902035.
 *
 * This plugin modifies the webpack bootstrap code generated by the plugin at
 * webpack/lib/web/JsonpMainTemplatePlugin.js
 *
 * It will rename the function jsonpScriptSrc generated by that to webpackJsonpScriptSrc
 * and install a new version that checks a user provided variable containing a script
 * version parameter to specify in async chunk URLs.
 *
 * This is only for webpack 4 (tested with 4.43 and 4.44).
 *
 * Webpack 5 has official support for this https://github.com/webpack/webpack/pull/8462
 * so it won't be necessary.
 */
class JsonpScriptSrcVersionParameterPlugin {
	_applyMainTemplate( mainTemplate ) {
		// tapable/lib/Hook.js
		// use stage 1 to ensure this executes after webpack/lib/web/JsonpMainTemplatePlugin.js
		mainTemplate.hooks.localVars.tap(
			{ name: pluginName, stage: 1 },
			( source ) => {
				if ( source.includes( 'function jsonpScriptSrc' ) ) {
					const modSource = source.replace(
						'function jsonpScriptSrc',
						'function webpackJsonpScriptSrc'
					);
					return `${ modSource }

var userGetScriptSrc = window.__webpack_get_script_src__;
function jsonpScriptSrc(chunkId) {
	var src = webpackJsonpScriptSrc(chunkId);
	if ( window.wcAdminAssets && window.wcAdminAssets.version ) {
		src += '?ver=' + window.wcAdminAssets.version;
	}
	return src;
}
`;
				}

				return source;
			}
		);
	}

	apply( compiler ) {
		compiler.hooks.thisCompilation.tap( pluginName, ( compilation ) => {
			this._applyMainTemplate( compilation.mainTemplate );
		} );
	}
}

module.exports = JsonpScriptSrcVersionParameterPlugin;
